name: Mirror Repositories

on:
  workflow_dispatch:
  push:
    paths:
      - 'meta/*.json'

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "mirror-bot"
          git config --global user.email "mirror-bot@users.noreply.github.com"

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Mirror projects from meta/
        run: |
          set -e
          mkdir -p mirrors

          for file in meta/*.json; do
            echo "üîÑ Processing $file..."

            REPO=$(jq -r '.repo' "$file")
            NAME=$(jq -r '.name' "$file" | sed 's/ (Archived)//;s/ (Deleted)//')
            ENABLED=$(jq -r '.sync_enabled' "$file")

            if [ "$ENABLED" != "true" ]; then
              echo "‚ö†Ô∏è Skipping $NAME (sync disabled)"
              continue
            fi

            DEST="mirrors/$NAME"

            if [ -d "$DEST/.git" ]; then
              echo "üîÅ Updating $NAME..."
              git -C "$DEST" fetch origin || continue
              DEFAULT_BRANCH=$(git -C "$DEST" remote show origin | awk '/HEAD branch/ { print $NF }')
              git -C "$DEST" reset --hard "origin/$DEFAULT_BRANCH"
            else
              echo "üì• Cloning $NAME..."
              git clone "https://github.com/$REPO.git" "$DEST"
            fi
          done

      - name: Commit changes if any
        run: |
          git add mirrors/
          git diff --cached --quiet || git commit -m "Mirror sync: $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
